/*! 
// ==UserScript==
// @namespace https://github.com/dotennin/baidu-pan-downloader
// @name 百度网盘下载管理器
// @description A download manager for Baidu Yun
// @version 1.2.0
// @author Dotennin
// @license MIT
// @compatible        chrome/83.0.4103.97 passed
// @compatible        edge/83.0.478.54 passed
// @compatible        firefox untested
// @compatible        opera untested
// @compatible        safari untested
// @include https://pan.baidu.com/disk/*
// @connect baidu.com
// @connect qdall01.baidupcs.com
// @resource customStyle https://dotennin.github.io/baidu-pan-downloader/src/style.css
// @grant GM_setClipboard
// @grant GM_xmlhttpRequest
// @grant GM_getResourceText
// @grant GM_download
// @grant GM_addStyle
// @grant GM_notification
// @grant GM_getValue
// @grant GM_setValue
// @grant GM_deleteValue
// @grant GM_addValueChangeListener
// @run-at document-idle
// ==/UserScript==
 */
!function(e){var t={};function n(o){if(t[o])return t[o].exports;var a=t[o]={i:o,l:!1,exports:{}};return e[o].call(a.exports,a,a.exports,n),a.l=!0,a.exports}n.m=e,n.c=t,n.d=function(e,t,o){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(n.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var a in e)n.d(o,a,function(t){return e[t]}.bind(null,a));return o},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=3)}([function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.d(__webpack_exports__,"a",(function(){return InstanceForSystem}));var _types__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(1),_gmInterface_gmInterface__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(2),InstanceForSystem={list:eval("require('system-core:context/context.js')").instanceForSystem.list,autoStart:!0,maxDownloadCount:1,downloadingItems:{},stoppedItems:{},completedItems:{},allDownloads:{},initState:function(){var e=this,t=_gmInterface_gmInterface__WEBPACK_IMPORTED_MODULE_1__.a.getValue(_types__WEBPACK_IMPORTED_MODULE_0__.b.items,{});return _gmInterface_gmInterface__WEBPACK_IMPORTED_MODULE_1__.a.deleteValue(_types__WEBPACK_IMPORTED_MODULE_0__.b.items),this.allDownloads=t,Object.values(t).forEach((function(t){t.status===_types__WEBPACK_IMPORTED_MODULE_0__.a.completed&&(e.completedItems[t.fs_id]=t),t.status===_types__WEBPACK_IMPORTED_MODULE_0__.a.stopped&&(e.stoppedItems[t.fs_id]=t)})),this},get selectedList(){return this.list.getSelected().filter((function(e){return 1!==e.isdir}))},get itemsFromQueue(){var e=this,t={},n=Object.keys(Object.assign({},this.downloadingItems,this.completedItems,this.stoppedItems));return Object.keys(this.allDownloads).forEach((function(o){n.includes(o)||(t[o]=e.allDownloads[o])})),t},get downloadable(){return Object.keys(this.downloadingItems).length<this.maxDownloadCount},get currentList(){return this.list.getCurrentList()},stopAll:function(){Object.values(this.downloadingItems).forEach((function(e){e.request&&e.request.abort&&e.request.abort()}))}}},function(e,t,n){"use strict";var o,a;n.d(t,"a",(function(){return o})),n.d(t,"b",(function(){return a})),function(e){e.downloading="DOWNLOADING",e.stopped="STOPPED",e.completed="COMPLETED",e.inQueued="IN_QUEUED",e.error="ERROR"}(o||(o={})),function(e){e.items="ITEM_LIST"}(a||(a={}))},function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.d(__webpack_exports__,"a",(function(){return GM}));var GM={addStyle:function(e){GM_addStyle(e)},deleteValue:function(e){GM_deleteValue(e)},listValues:function listValues(){eval("GM_listValues()")},addValueChangeListener:function(e,t){return GM_addValueChangeListener(e,t)},removeValueChangeListener:function(e){GM_removeValueChangeListener(e)},setValue:function(e,t){GM_setValue(e,t)},getValue:function(e,t){return GM_getValue(e,t)},log:function(e){GM_log(e)},getResourceText:function(e){return GM_getResourceText(e)},getResourceURL:function(e){return GM_getResourceURL(e)},registerMenuCommand:function(e,t,n){return GM_registerMenuCommand(e,t,n)},unregisterMenuCommand:function(e){GM_unregisterMenuCommand(e)},openInTab:function(e,t){GM_openInTab(e,t)},xmlHttpRequest:function(e){return GM_xmlhttpRequest(e)},download:function(e,t){return"string"==typeof e?GM_download(e,t):GM_download(e)},getTab:function(e){GM_getTab(e)},saveTab:function(e){GM_saveTab(e)},getTabs:function(e){GM_getTabs(e)},notification:function(e,t,n,o){"string"==typeof e?GM_notification(e,t,n,o):GM_notification(e,t)},setClipboard:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{type:"text",mimetype:"text/plain"};GM_setClipboard(e,t)},info:GM_info}},function(e,t,n){"use strict";n.r(t),n.d(t,"renderOperationElement",(function(){return p}));var o,a=n(0),s=n(1),r=n(2),i=function(e){if(e<=1e3)return"".concat(e," B");var t=Math.round(e/1024);return t<=1e3?"".concat(t," KB"):"".concat(Math.round(t/10.24)/100," MB")};function d(e){if(a.a.stoppedItems[e.fs_id]&&delete a.a.stoppedItems[e.fs_id],!a.a.downloadable)return e.status=s.a.inQueued,void p(e);e.status=s.a.downloading,p(e),a.a.downloadingItems[e.fs_id]=e;var t=e.url,n=e.server_filename,o=0,d=void 0,c=document.querySelector('div[data-label="'.concat(e.fs_id,'"]')),u=c.parentElement,_=c.closest("tr").querySelector('td[data-label="speed"]');e.request=r.a.download({url:t,name:n,saveAs:!0,headers:{Host:"qdall01.baidupcs.com",Accept:"*/*","User-Agent":"netdisk;P2SP;2.2.60.26","Accept-Encoding":"identity","Accept-Language":"ja-JP","Accept-Charset":"*"},onprogress:function(e){d=e;var t=Math.round(100*d.loaded/d.total);u.className="progress-radial progress-".concat(t),c.innerText="".concat(t,"%")},onload:function(){e.progress_loader_id&&clearInterval(e.progress_loader_id),u.className="progress-radial progress-100",c.innerText="100%",_.innerText="",a.a.completedItems[e.fs_id]=e,delete a.a.downloadingItems[e.fs_id],r.a.notification({text:"下载完成",title:n,highlight:!0}),e.status=s.a.completed,p(e),l()},onerror:function(){e.progress_loader_id&&clearInterval(e.progress_loader_id),u.className="progress-radial progress-0",c.innerHTML='<span style="color: red">error</span>',_.innerText="",a.a.stoppedItems[e.fs_id]=e,delete a.a.downloadingItems[e.fs_id],e.status=s.a.error,p(e),l()}}),e.progress_loader_id=setInterval((function(){if(d){var e=d.loaded-o;o=d.loaded,_.innerText="".concat(i(e),"/s")}}),1e3)}function l(){for(var e in a.a.itemsFromQueue)d(a.a.allDownloads[e])}function c(){var e=document.querySelector(".modal-wrapper");e.className=e.className+" open"}function u(){document.querySelector(".modal-wrapper").className="modal-wrapper"}function _(e){document.getElementById("popup-tbody").insertAdjacentHTML("beforeend",'\n        <tr id="row-'.concat(e.fs_id,'">\n          <td data-label="filename">').concat(e.server_filename,'</td>\n          <td data-label="download">\n            <div class="wrap">\n              <div class="progress-radial progress-').concat(e.status===s.a.completed?"100":"0",'">\n                <div data-label="').concat(e.fs_id,'"\n                    class="overlay">').concat(e.status===s.a.completed?"100":"0",'%</div>\n              </div>\n            </div>\n          </td>\n          <td data-label="url">').concat(i(e.size),'</td>\n          <td data-label="speed"></td>\n          <td data-label="operation"></td>\n        </tr>\n  ')),p(e)}function p(e){var t=document.getElementById("row-".concat(e.fs_id)).querySelector('td[data-label="operation"]');if(t){t.innerHTML="",t.insertAdjacentHTML("beforeend",'\n            <svg\n                id="start-item-'.concat(e.fs_id,'"\n                class="').concat([s.a.downloading,s.a.inQueued].includes(e.status)?"disabled":"",'"\n                xmlns="http://www.w3.org/2000/svg"\n                height="24"\n                viewBox="0 0 24 24"\n                width="24">\n                <path d="M0 0h24v24H0z" fill="none"/>\n                <path d="M8 5v14l11-7z"/>\n            </svg>\n            <svg\n                id="stop-item-').concat(e.fs_id,'"\n                class="').concat([s.a.downloading,s.a.inQueued].includes(e.status)?"":"disabled",'"\n                xmlns="http://www.w3.org/2000/svg"\n                height="24"\n                viewBox="0 0 24 24"\n                width="24">\n                    <path d="M0 0h24v24H0z" fill="none"/>\n                    <path d="M6 6h12v12H6z"/>\n            </svg>\n            <svg\n                id="delete-item-').concat(e.fs_id,'"\n                class="delete-item"\n                style="cursor: pointer; position: absolute; right: 5px"\n                xmlns="http://www.w3.org/2000/svg"\n                height="24" viewBox="0 0 24 24" width="24">\n                    <path d="M0 0h24v24H0z" fill="none"/>\n                    <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>\n            </svg>\n    '));var n=a.a.allDownloads,o=a.a.downloadingItems,r=a.a.completedItems,i=a.a.stoppedItems;document.getElementById("start-item-".concat(e.fs_id)).addEventListener("click",(function(){d(e)})),document.getElementById("stop-item-".concat(e.fs_id)).addEventListener("click",(function(){var t=a.a.downloadingItems[e.fs_id];if(t)return confirm("停止后将需要重新下载， 确认吗？")&&(e.status=s.a.stopped,t.request&&t.request.abort&&t.request.abort(),clearInterval(t.progress_loader_id),i[e.fs_id]=e,delete o[e.fs_id],p(e),l()),!1})),document.getElementById("delete-item-".concat(e.fs_id)).addEventListener("click",(function(){e.request&&e.request.abort&&e.request.abort(),delete n[e.fs_id],delete o[e.fs_id],delete r[e.fs_id],delete i[e.fs_id],document.getElementById("popup-tbody").removeChild(document.getElementById("row-".concat(e.fs_id))),l()}))}}window.onunload=function(){r.a.setValue(s.b.items,a.a.allDownloads),a.a.stopAll()},o=r.a.getResourceText("customStyle"),r.a.addStyle(o),document.body.insertAdjacentHTML("beforeend",'\n        <div class="modal-wrapper">\n            <div class="modal-overlay"></div>\n            <div class="modal-window">\n                <div class="modal-content">\n\x3c!--                    <button id="copy-code" class="disable">复制到剪切板</button>--\x3e\n              <table>\n                <thead>\n                  <tr>\n                    <th scope="col">文件</th>\n                    <th scope="col">进度</th>\n                    <th scope="col">大小</th>\n                    <th scope="col">速度</th>\n                    <th scope="col">操作</th>\n                  </tr>\n                </thead>\n                <tbody id="popup-tbody"></tbody>\n              </table>\n                </div>\n\x3c!--                <span class="modal-close">×</a>--\x3e\n            </div>\n        </div>\n        <div id="container-floating">\n          <div class="nd1 nds" data-toggle="tooltip" data-placement="left" onclick="alert(\'此功能正在开发中...\')">\n              <img class="reminder" src="https://ssl.gstatic.com/bt/C3341AA7A1A076756462EE2E5CD71C11/1x/bt_compose2_1x.png">\n          </div>\n          <div id="floating-button" data-toggle="tooltip" data-placement="left" data-original-title="Create">\n            <p class="plus">+</p>\n            <img class="edit" src="//ssl.gstatic.com/bt/C3341AA7A1A076756462EE2E5CD71C11/1x/ic_reminders_speeddial_white_24dp.png">\n          </div>\n        </div>\n    '),document.querySelectorAll(".modal-overlay,.modal-close").forEach((function(e){return e.addEventListener("click",u)})),document.querySelector("#floating-button").addEventListener("click",c),Object.values(a.a.initState().allDownloads).forEach((function(e){_(e),e.status===s.a.downloading&&a.a.downloadable&&d(e)})),r.a.addValueChangeListener(s.b.items,(function(e,t,n){Object.values(n).forEach((function(e){p(e)}))})),document.getElementById("floating-button").addEventListener("click",(function(){var e,t,n,o;c(),e=a.a.selectedList,t=a.a.allDownloads,n=a.a.autoStart,o=[],e.forEach((function(e){void 0===t[e.fs_id]&&(e.status=s.a.inQueued,t[e.fs_id]=e,_(e),o.push(function(e){return new Promise((function(t,n){r.a.xmlHttpRequest({url:"http://pcs.baidu.com/rest/2.0/pcs/file?app_id=778750&ver=2.0&method=locatedownload&path="+encodeURIComponent(e.path),method:"GET",responseType:"json",headers:{"User-Agent":"netdisk;P2SP;2.2.60.26"},onload:function(o){if(o.response.hasOwnProperty("client_ip")){var a=o.response.urls[0].url+"&filename="+encodeURIComponent(e.server_filename);return e.url=a,t(e)}return n(o)}})}))}(e)))})),Promise.all(o).then((function(e){e.forEach((function(e){n&&d(e)}))}))}))}]);